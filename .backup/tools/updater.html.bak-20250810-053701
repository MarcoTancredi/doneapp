<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Atualizador de Arquivos — Protocolo Único (ACR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px;background:#0f1220;color:#f5f7ff}
    .card{background:#14182a;border:1px solid #263055;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.35);}
    textarea{width:100%;height:320px;border-radius:12px;border:1px solid #2b365f;background:#0b0f1f;color:#e7ecff;padding:12px;font-family:ui-monospace, Menlo, Consolas, "Liberation Mono", monospace}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    input[type=text]{flex:1;min-width:280px;border-radius:12px;border:1px solid #2b365f;background:#0b0f1f;color:#e7ecff;padding:10px}
    .btn{border:0;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer;background:#7aa2ff;color:#0b0f1f}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.green{background:#54d988;color:#092515}
    .btn.red{background:#ff7a7a;color:#2a0b0b}
    .btn.blue{background:#7aa2ff;color:#0b0f1f}
    .muted{color:#9fb2ff;font-size:12px}
    pre{white-space:pre-wrap;background:#0b0f1f;border:1px solid #2b365f;border-radius:12px;padding:10px}
  </style>
</head>
<body>
  <h1>Atualizador de Arquivos — Protocolo Único (ACR)</h1>
  <div class="card">
    <div class="row">
      <input id="workspace" type="text" value="D:\bin\DoneApp" placeholder="Workspace root (ex.: C:\projetos\play)" />
      <input id="endpoint" type="text" value="http://localhost:5000/apply" placeholder="Endpoint (ex.: http://localhost:5000/apply)" />
    </div>
    <div class="row">
      <button id="sendBtn"    class="btn blue">Aplicar</button>
      <button id="condaBtn"   class="btn">Conda</button>
      <button id="serverBtn"  class="btn">Server</button>
      <button id="restartBtn" class="btn">Restart</button>
      <button id="commitBtn"  class="btn">Commit</button>
      <button id="clearBtn"   class="btn">Clear</button>
    </div>
    <textarea id="protocol" placeholder="# Cole aqui o protocolo ACR..."></textarea>
    <p class="muted">Âncora é opcional e <strong>sagrada</strong> — jamais alterada. Cut é por <strong>linhas inteiras</strong>.</p>
    <h3>Log</h3>
    <pre id="log"></pre>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setBtnState(btn, cls) {
      btn.classList.remove('green','red','blue');
      if (cls) btn.classList.add(cls);
    }

    function cooldown(btn, finalClass) {
      btn.disabled = true;
      setTimeout(() => {
        btn.disabled = false;
        if (finalClass) setBtnState(btn, finalClass);
      }, 3000);
    }

    async function copyToClipboard(text) {
      try { await navigator.clipboard.writeText(text); } catch(e){}
    }

    function baseUrl() {
      return $('endpoint').value.trim().replace(/\/?apply$/,'');
    }

    async function apply() {
      const btn = $('sendBtn');
      cooldown(btn); setBtnState(btn, 'green'); // verde ao clicar
      const endpoint = $('endpoint').value.trim();
      const workspace = $('workspace').value.trim();
      const payload = { workspace_root: workspace, protocol_text: $('protocol').value };
      try {
        const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        const output = data.output || JSON.stringify(data, null, 2);
        $('log').textContent = output;
        copyToClipboard(output);
        if (/\[ERRO\]/.test(output) || /Erro:/i.test(output)) setBtnState(btn, 'red'); else setBtnState(btn, 'blue');
      } catch (e) {
        $('log').textContent = "Erro: " + e.message;
        setBtnState(btn, 'red');
      }
    }

    async function pingStatus() {
      try {
        const res = await fetch(baseUrl() + '/status');
        if (!res.ok) return null;
        return await res.json();
      } catch(e){ return null; }
    }

    async function checkConda() {
      const btn = $('condaBtn'); cooldown(btn);
      const st = await pingStatus();
      if (st && st.conda_ok) { setBtnState(btn, 'green'); $('log').textContent = 'Conda: ON (PATH)'; }
      else { setBtnState(btn, 'red'); $('log').textContent = 'Conda: OFF (ativação real é no shell)'; }
    }

    async function checkServer() {
      const btn = $('serverBtn'); cooldown(btn);
      const st = await pingStatus();
      if (st && st.server === 'on') { setBtnState(btn, 'green'); $('log').textContent = 'Server: ON'; }
      else { setBtnState(btn, 'red'); $('log').textContent = 'Server: OFF'; }
    }

    async function doRestart() {
      const btn = $('restartBtn');
      // fica verde ao clicar e volta para AZUL após 3s
      setBtnState(btn, 'green');
      cooldown(btn, 'blue');
      try {
        const res = await fetch(baseUrl() + '/restart', { method:'POST' });
        if (res && res.ok) {
          $('log').textContent = 'Restart solicitado (o runner relança o servidor).';
        } else {
          $('log').textContent = 'Restart solicitado.';
        }
      } catch(e) {
        // se o processo cair antes da resposta, registramos a nota sem mudar a cor final
        $('log').textContent = 'Restart solicitado (conexão foi fechada durante o reinício).';
      }
    }

    async function doCommit() {
      const btn = $('commitBtn'); cooldown(btn);
      const st = await pingStatus();
      const workspace = $('workspace').value.trim();
      if (!st || !st.git_inited) {
        const name = prompt("git user.name:");
        const email = prompt("git user.email:");
        if (!name || !email) { $('log').textContent = 'git init cancelado'; return; }
        try {
          const r = await fetch(baseUrl() + '/git/init', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({workspace_root: workspace, name, email})});
          const data = await r.json();
          if (!data.ok) { $('log').textContent = 'git init ERRO: ' + (data.error||''); setBtnState(btn,'red'); return; }
        } catch(e){ $('log').textContent='git init ERRO: '+e.message; setBtnState(btn,'red'); return; }
      }
      const msg = prompt('Commit message:', 'update');
      if (!msg) { $('log').textContent = 'commit cancelado'; return; }
      try {
        const r = await fetch(baseUrl() + '/git/commit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({workspace_root: workspace, message: msg, push: false})});
        const data = await r.json();
        if (!data.ok) { $('log').textContent = 'commit ERRO: ' + (data.error || ''); setBtnState(btn,'red'); }
        else { $('log').textContent = data.output || 'commit ok'; setBtnState(btn,'blue'); copyToClipboard(data.output||''); }
      } catch(e) { $('log').textContent = 'commit ERRO: ' + e.message; setBtnState(btn,'red'); }
    }

    function clearAll() {
      const btn = $('clearBtn');
      cooldown(btn);
      $('protocol').value = '';
      $('log').textContent = '';
      // todos os botões voltam à cor padrão (azul)
      ['sendBtn','condaBtn','serverBtn','restartBtn','commitBtn','clearBtn'].forEach(id => {
        const el = $(id);
        if (el) setBtnState(el, 'blue');
      });
    }

    $('sendBtn').addEventListener('click', apply);
    $('condaBtn').addEventListener('click', checkConda);
    $('serverBtn').addEventListener('click', checkServer);
    $('restartBtn').addEventListener('click', doRestart);
    $('commitBtn').addEventListener('click', doCommit);
    $('clearBtn').addEventListener('click', clearAll);
  </script>
</body>
</html>
